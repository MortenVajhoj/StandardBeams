
from PySide import QtWidgets, QtCore, QtGui


rectangular_tubes = [
    ["50x30x2.6", "382", "50", "30", "122000", "53800", "6120", "4250"],
    ["50x30x3.2", "460", "50", "30", "142000", "62000", "7250", "5000"],
    ["50x30x4", "559", "50", "30", "165000", "70800", "8590", "5880"],
    ["50x30x5", "673", "50", "30", "187000", "78900", "10000", "6800"],
    ["60x40x2.6", "486", "60", "40", "236000", "124000", "9650", "7260"],
    ["60x40x3.2", "588", "60", "40", "278000", "146000", "11500", "8640"],
    ["60x40x4", "719", "60", "40", "328000", "170000", "13800", "10300"],
    ["60x40x5", "873", "60", "40", "381000", "195000", "16400", "12200"],
    ["60x40x6.3", "1060", "60", "40", "434000", "219000", "19200", "14200"],
    ["70x40x3", "614", "70", "40", "388000", "159500", "13800", "9300"],
    ["70x40x4", "799", "70", "40", "485000", "196000", "17600", "11800"],
    ["80x40x3.2", "716", "80", "40", "572000", "189000", "18000", "11000"],
    ["80x40x4", "879", "80", "40", "682000", "222000", "21800", "13200"],
    ["80x40x5", "1070", "80", "40", "803000", "257000", "26100", "15700"],
    ["80x40x6.3", "1310", "80", "40", "933000", "292000", "31100", "18400"],
    ["80x40x8", "1600", "80", "40", "1060000", "321000", "36500", "21200"],
    ["90x50x3.2", "844", "90", "50", "891000", "353000", "24600", "16200"],
    ["90x50x4", "1040", "90", "50", "1070000", "419000", "29800", "19600"],
    ["90x50x5", "1270", "90", "50", "1270000", "492000", "36000", "23500"],
    ["90x50x6.3", "1560", "90", "50", "1500000", "570000", "43200", "28000"],
    ["90x50x8", "1920", "90", "50", "1740000", "646000", "51400", "32900"],
    ["100x50x3.2", "908", "100", "50", "1160000", "388000", "28900", "17700"],
    ["100x50x4", "1120", "100", "50", "1400000", "462000", "35200", "21500"],
    ["100x50x5", "1370", "100", "50", "1670000", "543000", "42600", "25800"],
    ["100x50x6.3", "1690", "100", "50", "1970000", "630000", "51300", "30800"],
    ["100x50x8", "2080", "100", "50", "2300000", "717000", "61400", "36300"],
    ["100x60x3.2", "972", "100", "60", "1310000", "588000", "32000", "22400"],
    ["100x60x4", "1200", "100", "60", "1580000", "705000", "39100", "27300"],
    ["100x60x5", "1470", "100", "60", "1890000", "836000", "47400", "32900"],
    ["100x60x6.3", "1810", "100", "60", "2250000", "981000", "57300", "39500"],
    ["100x60x8", "2240", "100", "60", "2640000", "1130000", "68700", "47100"],
    ["120x60x4", "1360", "120", "60", "2490000", "831000", "51900", "31700"],
    ["120x60x5", "1670", "120", "60", "2990000", "988000", "63100", "38400"],
    ["120x60x6.3", "2070", "120", "60", "3580000", "1160000", "76700", "46300"],
    ["120x60x8", "2560", "120", "60", "4250000", "1350000", "92700", "55400"],
    ["120x60x10", "3090", "120", "60", "4880000", "1520000", "109000", "64400"],
    ["120x80x4", "1520", "120", "80", "3030000", "1610000", "61200", "46100"],
    ["120x80x5", "1870", "120", "80", "3650000", "1930000", "74600", "56100"],
    ["120x80x6.3", "2320", "120", "80", "4400000", "2300000", "91000", "68200"],
    ["120x80x8", "2880", "120", "80", "5250000", "2730000", "111000", "82600"],
    ["120x80x10", "3490", "120", "80", "6090000", "3130000", "131000", "97300"],
    ["140x80x4", "1680", "140", "80", "4410000", "1840000", "77100", "52200"],
    ["140x80x5", "2070", "140", "80", "5340000", "2210000", "94300", "63600"],
    ["140x80x6.3", "2570", "140", "80", "6460000", "2650000", "115000", "77500"],
    ["140x80x8", "3200", "140", "80", "7760000", "3140000", "141000", "94100"],
    ["140x80x10", "3890", "140", "80", "9080000", "3620000", "168000", "111000"],
    ["150x100x4", "1920", "150", "100", "6070000", "3240000", "97400", "73600"],
    ["150x100x5", "2370", "150", "100", "7390000", "3920000", "119000", "90100"],
    ["150x100x6.3", "2950", "150", "100", "8980000", "4740000", "147000", "110000"],
    ["150x100x8", "3680", "150", "100", "10870000", "5690000", "180000", "135000"],
    ["150x100x10", "4490", "150", "100", "12820000", "6650000", "216000", "161000"],
    ["150x100x12.5", "5460", "150", "100", "14880000", "7630000", "256000", "190000"],
    ["160x80x4", "1840", "160", "80", "6120000", "2070000", "94700", "58300"],
    ["160x80x5", "2270", "160", "80", "7440000", "2490000", "116000", "71100"],
    ["160x80x6.3", "2820", "160", "80", "9030000", "2990000", "142000", "86800"],
    ["160x80x8", "3520", "160", "80", "10910000", "3560000", "175000", "106000"],
    ["160x80x10", "4290", "160", "80", "12840000", "4110000", "209000", "125000"],
    ["160x80x12.5", "5210", "160", "80", "14850000", "4650000", "247000", "146000"],
    ["180x100x4", "2160", "180", "100", "9450000", "3790000", "128000", "85200"],
    ["180x100x5", "2670", "180", "100", "11530000", "4600000", "157000", "104000"],
    ["180x100x6.3", "3330", "180", "100", "14070000", "5570000", "194000", "128000"],
    ["180x100x8", "4160", "180", "100", "17130000", "6710000", "239000", "157000"],
    ["180x100x10", "5090", "180", "100", "20360000", "7870000", "288000", "188000"],
    ["180x100x12.5", "6210", "180", "100", "23850000", "9080000", "344000", "223000"],
    ["200x100x4", "2320", "200", "100", "12230000", "4160000", "150000", "93000"],
    ["200x100x5", "2870", "200", "100", "14950000", "5050000", "185000", "114000"],
    ["200x100x6.3", "3580", "200", "100", "18290000", "6130000", "228000", "140000"],
    ["200x100x8", "4480", "200", "100", "22340000", "7390000", "282000", "172000"],
    ["200x100x10", "5490", "200", "100", "26640000", "8690000", "341000", "206000"],
    ["200x100x12.5", "6710", "200", "100", "31360000", "10040000", "408000", "245000"],
    ["200x100x16", "8300", "200", "100", "36780000", "11470000", "491000", "290000"],
    ["200x120x6.3", "3830", "200", "120", "20650000", "9290000", "253000", "177000"],
    ["200x120x8", "4800", "200", "120", "25290000", "11280000", "313000", "218000"],
    ["200x120x10", "5890", "200", "120", "30260000", "13370000", "379000", "263000"],
    ["200x120x12.5", "7210", "200", "120", "35760000", "15620000", "455000", "314000"],
    ["250x150x6.3", "4840", "250", "150", "41430000", "18740000", "402000", "283000"],
    ["250x150x8", "6080", "250", "150", "51110000", "22980000", "501000", "350000"],
    ["250x150x10", "7490", "250", "150", "61740000", "27550000", "611000", "426000"],
    ["250x150x12.5", "9210", "250", "150", "73870000", "32650000", "740000", "514000"],
    ["250x150x14.2", "10300", "250", "150", "81410000", "35760000", "823000", "570000"],
    ["250x150x16", "11500", "250", "150", "88790000", "38730000", "906000", "625000"],
    ["260x180x6.3", "5340", "260", "180", "51660000", "29290000", "475000", "369000"],
    ["260x180x8", "6720", "260", "180", "63900000", "36080000", "592000", "459000"],
    ["260x180x10", "8290", "260", "180", "77410000", "43510000", "724000", "560000"],
    ["260x180x12.5", "10200", "260", "180", "92990000", "51960000", "879000", "679000"],
    ["260x180x14.2", "11500", "260", "180", "102800000", "57190000", "980000", "755000"],
    ["260x180x16", "12800", "260", "180", "112500000", "62310000", "1081000", "831000"],
    ["300x200x6.3", "6100", "300", "200", "78290000", "41930000", "624000", "472000"],
    ["300x200x8", "7680", "300", "200", "97170000", "51840000", "779000", "589000"],
    ["300x200x10", "9490", "300", "200", "118200000", "62780000", "956000", "721000"],
    ["300x200x12.5", "11700", "300", "200", "142700000", "75370000", "1165000", "877000"],
    ["300x200x14.2", "13200", "300", "200", "158300000", "83280000", "1302000", "978000"],
    ["300x200x16", "14700", "300", "200", "173900000", "91090000", "1441000", "1080000"],
    ["350x250x6.3", "7360", "350", "250", "132000000", "78850000", "892000", "709000"],
    ["350x250x8", "9280", "350", "250", "164500000", "97980000", "1118000", "888000"],
    ["350x250x10", "11500", "350", "250", "201000000", "119400000", "1375000", "1091000"],
    ["350x250x12.5", "14200", "350", "250", "244200000", "144400000", "1685000", "1334000"],
    ["350x250x14.2", "16000", "350", "250", "272000000", "160500000", "1887000", "1492000"],
    ["350x250x16", "17900", "350", "250", "300100000", "176500000", "2095000", "1655000"],
    ["400x200x8", "9280", "400", "200", "195600000", "66600000", "1203000", "743000"],
    ["400x200x10", "11500", "400", "200", "239100000", "80840000", "1480000", "911000"],
    ["400x200x12.5", "14200", "400", "200", "290600000", "97380000", "1813000", "1111000"],
    ["400x200x14.2", "16000", "400", "200", "323800000", "107800000", "2032000", "1242000"],
    ["400x200x16", "17900", "400", "200", "357400000", "118200000", "2256000", "1374000"],
    ["450x250x8", "10900", "450", "250", "300800000", "121400000", "1622000", "1081000"],
    ["450x250x10", "13500", "450", "250", "369000000", "148200000", "2000000", "1331000"],
    ["450x250x12.5", "16700", "450", "250", "450300000", "179700000", "2458000", "1631000"],
    ["450x250x14.2", "18900", "450", "250", "503200000", "200000000", "2759000", "1827000"],
    ["450x250x16", "21100", "450", "250", "557100000", "220400000", "3070000", "2029000"],
    ["500x300x10", "15500", "500", "300", "537600000", "244400000", "2595000", "1826000"],
    ["500x300x12.5", "19200", "500", "300", "658100000", "297800000", "3196000", "2244000"],
    ["500x300x14.2", "21700", "500", "300", "737000000", "332500000", "3593000", "2519000"],
    ["500x300x16", "24300", "500", "300", "817800000", "367700000", "4005000", "2804000"],
    ["500x300x20", "30000", "500", "300", "987800000", "440800000", "4885000", "3408000"],
]


class RectangularTubeDialog(QtWidgets.QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Rectangular Tube")
        self.setMinimumWidth(450)
        self.setup_ui()

    def setup_ui(self):
        layout = QtWidgets.QVBoxLayout(self)

        size_group = QtWidgets.QGroupBox("Select Size - From EN 10210-2 RHS Standard")
        size_layout = QtWidgets.QVBoxLayout(size_group)

        self.size_table = QtWidgets.QTableWidget()
        self.size_table.setColumnCount(8)
        self.size_table.setHorizontalHeaderLabels(["Shape", "Area (mm^2)", "Depth (mm)", "Width (mm)", "I_x (mm^4)", "I_y (mm^4)", "Plastic Modulus X (mm^3)", "Plastic Modulus Y (mm^3)"])
        self.size_table.setSelectionBehavior(QtWidgets.QAbstractItemView.SelectRows)
        self.size_table.setSelectionMode(QtWidgets.QAbstractItemView.SingleSelection)
        self.size_table.horizontalHeader().setStretchLastSection(True)
        self.size_table.verticalHeader().setVisible(False)
        self.populate_sizes()
        size_layout.addWidget(self.size_table)

        layout.addWidget(size_group)

        length_group = QtWidgets.QGroupBox("Beam Length")
        length_layout = QtWidgets.QHBoxLayout(length_group)

        length_layout.addWidget(QtWidgets.QLabel("Length:"))
        self.length_input = QtWidgets.QDoubleSpinBox()
        self.length_input.setRange(1, 100000)
        self.length_input.setValue(1000)
        self.length_input.setSuffix(" mm")
        self.length_input.setDecimals(2)
        length_layout.addWidget(self.length_input)

        layout.addWidget(length_group)

        button_box = QtWidgets.QDialogButtonBox(
            QtWidgets.QDialogButtonBox.Ok | QtWidgets.QDialogButtonBox.Cancel
        )
        button_box.accepted.connect(self.accept)
        button_box.rejected.connect(self.reject)
        layout.addWidget(button_box)

    def populate_sizes(self):
        self.size_table.setRowCount(len(rectangular_tubes))
        for row, size_data in enumerate(rectangular_tubes):
            for col, value in enumerate(size_data):
                item = QtWidgets.QTableWidgetItem(str(value))
                item.setFlags(item.flags() & ~QtCore.Qt.ItemIsEditable)
                self.size_table.setItem(row, col, item)
        self.size_table.resizeColumnsToContents()
        if rectangular_tubes:
            self.size_table.selectRow(0)

    def get_selected_size(self):
        row = self.size_table.currentRow()
        if row >= 0:
            return rectangular_tubes[row]
        return None

    def get_length(self):
        return self.length_input.value()

    def accept(self):
        if self.get_selected_size() is None:
            QtWidgets.QMessageBox.warning(self, "Warning", "Please select a size.")
            return
        super().accept()


def create_rectangular_tube(size_data, length):
    
    import FreeCAD
    import Part
    from FreeCAD import Placement, Rotation, Vector

    doc = FreeCAD.ActiveDocument
    if doc is None:
        doc = FreeCAD.newDocument()
    
    body = doc.addObject('PartDesign::Body', 'RectangularTubeBody')

    name = f"RectangularTube_Sketch"
    current_sketch = body.newObject('Sketcher::SketchObject', name)
    current_sketch.Placement = FreeCAD.Placement(FreeCAD.Vector(0, 0, 0), FreeCAD.Rotation(0, 0, 0, 1))

    dimensions = size_data[0].split('x')
    outer_points = [
        [0, 0],
        [0, float(dimensions[0])],
        [float(dimensions[1]), float(dimensions[0])],
        [float(dimensions[1]), 0],
    ]

    inner_points = [
        [float(dimensions[2]), float(dimensions[2])],
        [float(dimensions[2]), float(dimensions[0]) - float(dimensions[2])],
        [float(dimensions[1]) - float(dimensions[2]), float(dimensions[0]) - float(dimensions[2])],
        [float(dimensions[1]) - float(dimensions[2]), float(dimensions[2])],
    ]

    for i, pt in enumerate(outer_points):
        x1, y1 = pt
        x2, y2 = outer_points[(i + 1) % len(outer_points)]
        p1 = Vector(x1, y1, 0)
        p2 = Vector(x2, y2, 0)
        
        current_sketch.addGeometry(Part.LineSegment(p1, p2), False)

    for i, pt in enumerate(inner_points):
        x1, y1 = pt
        x2, y2 = inner_points[(i + 1) % len(inner_points)]
        p1 = Vector(x1, y1, 0)
        p2 = Vector(x2, y2, 0)
        
        current_sketch.addGeometry(Part.LineSegment(p1, p2), False)

    pad = body.newObject('PartDesign::Pad', "TubePad")
    pad.Type = "Length" 
    pad.Profile = current_sketch
    pad.Length = length
    pad.Reversed = False
    pad.Midplane = False

    current_sketch.Visibility = False

    body.recompute()
    body.Tip = pad
    doc.recompute()
